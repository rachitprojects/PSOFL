import torch
import socket
import multiprocessing
import numpy as np
import subprocess
ip_add = subprocess.check_output("ifconfig | head -n 2", shell=True)
num_cpu = subprocess.check_output("lscpu | tail -n +4 | head -n 2 | grep CPU", shell=True)
mem_max = subprocess.check_output("free -m | head -n 2 | grep Mem ", shell=True)
net_script = subprocess.check_output("cat ~/Desktop/netscript2.sh", shell=True)

import logging
logging.basicConfig(level = logging.INFO,format = '%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

import sys
sys.path.append('../')
from RLEnv import RL_Client
import config
import utils

if config.random:
	torch.manual_seed(config.random_seed)
	np.random.seed(config.random_seed)
	logger.info('Random seed: {}'.format(config.random_seed))

first = True
ip_address = '192.168.10.44'
index = 2
datalen = config.N / config.K
split_layer = config.split_layer[index]

logger.info('==> Preparing Data..')
cpu_count = multiprocessing.cpu_count()
trainloader, classes= utils.get_local_dataloader(index, cpu_count)

logger.info('==> Preparing RL_Client..')
rl_client = RL_Client(index, ip_address, config.SERVER_ADDR, config.SERVER_PORT, datalen, config.model_name, split_layer, config.model_cfg)
print("here")
print("IP address string is ", ip_address)
print("Device Index is ", index)
print("ifconfig IP address is ", ip_add)
print("Number of CPU is ", num_cpu)
print("Amount of memory is ", mem_max)
print("Network Script Output is ", net_script)

while True:
	reset_flag = rl_client.recv_msg(rl_client.sock, 'RESET_FLAG')[0][1]
	if reset_flag:
		rl_client.initialize(len(config.model_cfg[config.model_name])-1)
	else:
		logger.info('==> Next Timestep..')
		config.split_layer = rl_client.recv_msg(rl_client.sock, 'SPLIT_LAYERS')[0][1]
		rl_client.reinitialize(config.split_layer[index])

	logger.info('==> Training Start..')
	if first:
		rl_client.infer(trainloader)
		rl_client.infer(trainloader)
		first = False
	else:
		rl_client.infer(trainloader)

	
	


